<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheltuieli - Atelier TÃ¢mplÄƒrie</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ”¨ Eva Wood's - Project Manager</h1>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="index.html">ğŸ“Š Dashboard</a></li>
            <li><a href="clienti.html">ğŸ‘¥ ClienÈ›i</a></li>
            <li><a href="proiecte.html">ğŸ“ Proiecte</a></li>
            <li><a href="cheltuieli.html" class="active">ğŸ’° Cheltuieli</a></li>
            <li><a href="stoc.html">ğŸ“¦ Stoc</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="content-section">
            <div class="section-header">
                <h2>ğŸ’° Gestionare Cheltuieli</h2>
                <div>
                    <select id="filter-tip" onchange="filterByTip()">
                        <option value="">Toate tipurile</option>
                        <option value="materiale">Materiale</option>
                        <option value="manopera">ManoperÄƒ</option>
                        <option value="transport">Transport</option>
                        <option value="altele">Altele</option>
                    </select>
                    <button class="btn btn-primary" onclick="openAddModal()">â• AdaugÄƒ CheltuialÄƒ</button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Proiect</th>
                            <th>Tip CheltuialÄƒ</th>
                            <th>Descriere</th>
                            <th>SumÄƒ</th>
                            <th>AcÈ›iuni</th>
                        </tr>
                    </thead>
                    <tbody id="cheltuieli-tbody">
                        <tr>
                            <td colspan="6" class="text-center">Se Ã®ncarcÄƒ...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal AdaugÄƒ/EditeazÄƒ CheltuialÄƒ -->
    <div id="cheltuialaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">AdaugÄƒ CheltuialÄƒ NouÄƒ</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="cheltuialaForm" onsubmit="saveCheltuiala(event)">
                <input type="hidden" id="cheltuiala-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="proiect-id">Proiect *</label>
                        <select id="proiect-id" required>
                            <option value="">SelecteazÄƒ proiect...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tip-cheltuiala">Tip CheltuialÄƒ *</label>
                        <select id="tip-cheltuiala" required>
                            <option value="">SelecteazÄƒ tip...</option>
                            <option value="materiale">Materiale</option>
                            <option value="manopera">ManoperÄƒ</option>
                            <option value="transport">Transport</option>
                            <option value="altele">Altele</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="descriere">Descriere *</label>
                    <input type="text" id="descriere" required placeholder="Ex: Lemn stejar pentru blat">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="suma">SumÄƒ (RON) *</label>
                        <input type="number" id="suma" step="0.01" required placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="data-cheltuiala">Data CheltuialÄƒ</label>
                        <input type="date" id="data-cheltuiala">
                    </div>
                </div>

                <div class="form-group">
                    <label for="observatii">ObservaÈ›ii</label>
                    <textarea id="observatii" placeholder="Detalii suplimentare..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">AnuleazÄƒ</button>
                    <button type="submit" class="btn btn-success">ğŸ’¾ SalveazÄƒ</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let currentCheltuialaId = null;
        let allCheltuieli = [];

        // ÃncarcÄƒ cheltuielile È™i proiectele
        async function loadData() {
            try {
                // ÃncarcÄƒ cheltuieli
                allCheltuieli = await API.getCheltuieli();
                displayCheltuieli(allCheltuieli);

                // ÃncarcÄƒ proiecte pentru dropdown
                const proiecte = await API.getProiecte();
                populateProiectDropdown(proiecte);
            } catch (error) {
                showError('Eroare la Ã®ncÄƒrcarea datelor');
            }
        }

        function displayCheltuieli(cheltuieli) {
            const tbody = document.getElementById('cheltuieli-tbody');
            
            if (!cheltuieli || cheltuieli.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ’°</div>
                                <h3>Nu existÄƒ cheltuieli</h3>
                                <p>AdaugÄƒ prima cheltuialÄƒ pentru a Ã®ncepe</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = cheltuieli.map(ch => `
                <tr>
                    <td>${formatDate(ch.dataCheltuiala)}</td>
                    <td><strong>${ch.proiectNume}</strong></td>
                    <td><span class="badge badge-info">${ch.tipCheltuiala}</span></td>
                    <td>${ch.descriere}</td>
                    <td><strong>${formatCurrency(ch.suma)}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editCheltuiala(${ch.id})">âœï¸</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCheltuiala(${ch.id}, '${ch.descriere}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function populateProiectDropdown(proiecte) {
            const select = document.getElementById('proiect-id');
            select.innerHTML = '<option value="">SelecteazÄƒ proiect...</option>' + 
                proiecte.map(p => `<option value="${p.id}">${p.numeProiect} (${p.clientNume})</option>`).join('');
        }

        async function filterByTip() {
            const tip = document.getElementById('filter-tip').value;
            
            if (!tip) {
                displayCheltuieli(allCheltuieli);
                return;
            }

            try {
                const filtered = await API.getCheltuieliByTip(tip);
                // TransformÄƒ datele pentru a include proiectNume
                const enriched = filtered.map(ch => ({
                    ...ch,
                    tipCheltuiala: tip
                }));
                displayCheltuieli(enriched);
            } catch (error) {
                showError('Eroare la filtrarea cheltuielilor');
            }
        }

        function openAddModal() {
            currentCheltuialaId = null;
            document.getElementById('modal-title').textContent = 'AdaugÄƒ CheltuialÄƒ NouÄƒ';
            document.getElementById('cheltuialaForm').reset();
            document.getElementById('cheltuiala-id').value = '';
            
            // SeteazÄƒ data curentÄƒ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-cheltuiala').value = today;
            
            document.getElementById('cheltuialaModal').classList.add('active');
        }

        async function editCheltuiala(id) {
            try {
                const cheltuiala = await API.getCheltuiala(id);
                currentCheltuialaId = id;
                
                document.getElementById('modal-title').textContent = 'EditeazÄƒ CheltuialÄƒ';
                document.getElementById('cheltuiala-id').value = cheltuiala.id;
                document.getElementById('proiect-id').value = cheltuiala.proiectId;
                document.getElementById('tip-cheltuiala').value = cheltuiala.tipCheltuiala;
                document.getElementById('descriere').value = cheltuiala.descriere;
                document.getElementById('suma').value = cheltuiala.suma;
                document.getElementById('data-cheltuiala').value = cheltuiala.dataCheltuiala ? 
                    cheltuiala.dataCheltuiala.split('T')[0] : '';
                document.getElementById('observatii').value = cheltuiala.observatii || '';
                
                document.getElementById('cheltuialaModal').classList.add('active');
            } catch (error) {
                showError('Eroare la Ã®ncÄƒrcarea datelor cheltuielii');
            }
        }

        async function saveCheltuiala(event) {
            event.preventDefault();
            
            const cheltuialaData = {
                id: currentCheltuialaId || 0,
                proiectId: parseInt(document.getElementById('proiect-id').value),
                tipCheltuiala: document.getElementById('tip-cheltuiala').value,
                descriere: document.getElementById('descriere').value,
                suma: parseFloat(document.getElementById('suma').value),
                dataCheltuiala: document.getElementById('data-cheltuiala').value || new Date().toISOString().split('T')[0],
                observatii: document.getElementById('observatii').value || null
            };

            try {
                if (currentCheltuialaId) {
                    await API.updateCheltuiala(currentCheltuialaId, cheltuialaData);
                    showSuccess('CheltuialÄƒ actualizatÄƒ cu succes!');
                } else {
                    await API.createCheltuiala(cheltuialaData);
                    showSuccess('CheltuialÄƒ adÄƒugatÄƒ cu succes!');
                }
                
                closeModal();
                loadData();
            } catch (error) {
                showError('Eroare la salvarea cheltuielii');
            }
        }

        async function deleteCheltuiala(id, descriere) {
            if (confirmDelete(descriere)) {
                try {
                    await API.deleteCheltuiala(id);
                    showSuccess('CheltuialÄƒ È™tearsÄƒ cu succes!');
                    loadData();
                } catch (error) {
                    showError('Eroare la È™tergerea cheltuielii');
                }
            }
        }

        function closeModal() {
            document.getElementById('cheltuialaModal').classList.remove('active');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('cheltuialaModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ÃncarcÄƒ datele la pornire
        loadData();
    </script>
</body>
</html>