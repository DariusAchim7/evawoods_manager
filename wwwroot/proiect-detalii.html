<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalii Proiect - Atelier T√¢mplƒÉrie</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>üî® Eva Wood's </h1>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="index.html">üìä Dashboard</a></li>
            <li><a href="clienti.html">üë• Clien»õi</a></li>
            <li><a href="proiecte.html">üìÅ Proiecte</a></li>
            <li><a href="stoc.html">üì¶ Stoc</a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- Header Proiect -->
        <div class="content-section">
            <div class="section-header">
                <h2>üìÅ Detalii Proiect</h2>
                <div>
                    <button class="btn btn-primary" onclick="editProiect()">‚úèÔ∏è EditeazƒÉ Proiect</button>
                    <button class="btn btn-danger" onclick="deleteProiect()">üóëÔ∏è »òterge Proiect</button>
                    <a href="#" id="back-link" class="btn btn-secondary">‚Üê √énapoi</a>
                </div>
            </div>

            <!-- Card Proiect -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                    <div>
                        <h2 style="color: white; margin-bottom: 10px;" id="proiect-nume">...</h2>
                        <p style="margin: 0; opacity: 0.9;">
                            <strong>Client:</strong> <span id="proiect-client">...</span>
                        </p>
                    </div>
                    <div id="proiect-status-badge"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>üìÖ Data Start:</strong><br>
                        <span id="proiect-data-start">-</span>
                    </div>
                    <div>
                        <strong>üìÖ Data Finalizare:</strong><br>
                        <span id="proiect-data-finalizare">-</span>
                    </div>
                    <div>
                        <strong>üí∞ Pre»õ Estimat:</strong><br>
                        <span id="proiect-pret-estimat" style="font-size: 1.2em;">-</span>
                    </div>
                    <div>
                        <strong>üíµ Pre»õ Final:</strong><br>
                        <span id="proiect-pret-final" style="font-size: 1.2em;">-</span>
                    </div>
                </div>

                <div style="margin-top: 20px;" id="proiect-descriere-container">
                    <strong>üìù Descriere:</strong><br>
                    <span id="proiect-descriere">-</span>
                </div>
            </div>
        </div>

        <!-- Cheltuieli -->
        <div class="content-section">
            <div class="section-header">
                <h2>üí∞ Cheltuieli Proiect</h2>
                <button class="btn btn-primary" onclick="openAddCheltuialaModal()">‚ûï AdaugƒÉ CheltuialƒÉ</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tip</th>
                            <th>Descriere</th>
                            <th>Cantitate</th>
                            <th>Pret/Unitate</th>
                            <th>Pret final</th>
                            <th>Ac»õiuni</th>
                        </tr>
                    </thead>
                    <tbody id="cheltuieli-tbody">
                        <tr>
                            <td colspan="5" class="text-center">Se √ÆncarcƒÉ...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Breakdown Cheltuieli pe Tip -->
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;" id="breakdown-container">
                <h3 style="margin-bottom: 15px;">üìä Breakdown Cheltuieli</h3>
                <div id="breakdown-content"></div>
            </div>
            <!-- Statistici Financiare -->
            <div class="stats-grid">
                <div class="stat-card info">
                    <h3>üí∞ √éncasat</h3>
                    <div class="value" id="stat-incasat">0 RON</div>
                    <div class="label">Pre»õ estimat/final</div>
                </div>
                <div class="stat-card danger">
                    <h3>üí∏ Cheltuieli</h3>
                    <div class="value" id="stat-cheltuieli">0 RON</div>
                    <div class="label">Total costuri</div>
                </div>
                <div class="stat-card success">
                    <h3>üìà Profit</h3>
                    <div class="value" id="stat-profit">0 RON</div>
                    <div class="label">√éncasat - Cheltuieli</div>
                </div>
                <div class="stat-card warning">
                    <h3>üìä MarjƒÉ</h3>
                    <div class="value" id="stat-marja">0%</div>
                    <div class="label">Procent profit</div>
                </div>
            </div>
        </div>

        <!-- Calculator Cant -->
        <div class="content-section">
            <div class="section-header">
                <h2>üìê Calculator Cant</h2>
                <div>
                    <button class="btn btn-secondary" onclick="descarcaTemplateExcel()" title="DescarcƒÉ template Excel">
                        üì• DescarcƒÉ Template
                    </button>
                    <button class="btn btn-primary" onclick="openUploadExcelModal()">
                        üì§ Upload Excel
                    </button>
                </div>
            </div>
    
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Format Excel Necesar:</strong><br>
                Coloana 1: Lungime (mm) | Coloana 2: LƒÉ»õime (mm) | Coloana 3: Cant Lungime (0/1/2) | Coloana 4: Cant LƒÉ»õime (0/1/2)<br>
                <strong>Pierdere tehnologicƒÉ:</strong> 4mm (0,4cm) pe fiecare laturƒÉ cantatƒÉ
            </div>
    
            <!-- Lista calcule salvate -->
            <div id="calcule-lista" style="margin-bottom: 20px;">
                <h3>Calcule Salvate:</h3>
                <div id="calcule-items"></div>
            </div>
    
            <!-- Rezultat calcul -->
            <div id="calcul-result" style="display: none;">
                <div class="stat-card success">
                    <div id="total-cant"></div>
                </div>
    
                <h3 style="margin-top: 30px;">üìä Detalii Calcul:</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Lungime (mm)</th>
                                <th>LƒÉ»õime (mm)</th>
                                <th>Cant L</th>
                                <th>Cant l</th>
                                <th>Detalii Cant</th>
                                <th>Total Linie</th>
                            </tr>
                        </thead>
                        <tbody id="calcul-details"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Galerie Imagini -->
        <div class="content-section">
            <div class="section-header">
                <h2>üì∏ Galerie Imagini Proiect</h2>
                <button class="btn btn-primary" onclick="openUploadImageModal()">
                    üì§ Upload Imagine
                </button>
            </div>

            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Tipuri imagini:</strong> SchitƒÉ | Randare | Final<br>
                <strong>Formate acceptate:</strong> JPG, PNG, GIF, WEBP (max 10MB)
            </div>

            <!-- Filtre imagini -->
            <div style="margin-bottom: 20px;">
                <button class="btn btn-sm" onclick="filterImagini('toate')" id="filter-toate">Toate</button>
                <button class="btn btn-sm" onclick="filterImagini('schita')" id="filter-schita">Schi»õe</button>
                <button class="btn btn-sm" onclick="filterImagini('randare')" id="filter-randare">RandƒÉri</button>
                <button class="btn btn-sm" onclick="filterImagini('final')" id="filter-final">Finale</button>
            </div>

            <!-- Grid imagini -->
            <div id="galerie-imagini" class="image-grid">
                <p style="text-align: center; color: #999;">Se √ÆncarcƒÉ imagini...</p>
            </div>
        </div>

    
        <!-- Modal Upload Excel -->
        <div id="uploadExcelModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Upload Excel pentru Calcul Cant</h3>
                    <button class="close-btn" onclick="closeUploadExcelModal()">&times;</button>
                </div>
    
                <form id="uploadExcelForm" onsubmit="uploadExcelCant(event)">
                    <div class="form-group">
                        <label for="excel-file">SelecteazƒÉ fi»ôier Excel *</label>
                        <input type="file" id="excel-file" accept=".xlsx,.xls" required>
                        <small>Format: .xlsx sau .xls</small>
                    </div>
    
                    <div class="form-group">
                        <label for="observatii-cant">Observa»õii (op»õional)</label>
                        <textarea id="observatii-cant" placeholder="Ex: Calcul pentru corpuri bucƒÉtƒÉrie"></textarea>
                    </div>
    
                    <div id="preview-cant" style="display: none; margin-top: 20px;">
                        <h4>Previzualizare:</h4>
                        <div id="preview-content"></div>
                    </div>
    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeUploadExcelModal()">AnuleazƒÉ</button>
                        <button type="submit" class="btn btn-success">üíæ SalveazƒÉ Calcul</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal EditeazƒÉ Proiect -->
    <div id="proiectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>EditeazƒÉ Proiect</h3>
                <button class="close-btn" onclick="closeProiectModal()">&times;</button>
            </div>
            
            <form id="proiectForm" onsubmit="saveProiect(event)">
                <div class="form-group">
                    <label for="nume-proiect">Nume Proiect *</label>
                    <input type="text" id="nume-proiect" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" required>
                            <option value="planificat">Planificat</option>
                            <option value="in_lucru">√én lucru</option>
                            <option value="finalizat">Finalizat</option>
                            <option value="anulat">Anulat</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="pret-estimat">Pre»õ Estimat (RON)</label>
                        <input type="number" id="pret-estimat" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="pret-final">Pre»õ Final (RON)</label>
                    <input type="number" id="pret-final" step="0.01">
                </div>

                <div class="form-group">
                    <label for="descriere">Descriere</label>
                    <textarea id="descriere"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="data-start">Data Start</label>
                        <input type="date" id="data-start">
                    </div>
                    <div class="form-group">
                        <label for="data-finalizare">Data Finalizare</label>
                        <input type="date" id="data-finalizare">
                    </div>
                </div>

                <div class="form-group">
                    <label for="observatii">Observa»õii</label>
                    <textarea id="observatii"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProiectModal()">AnuleazƒÉ</button>
                    <button type="submit" class="btn btn-success">üíæ SalveazƒÉ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal AdaugƒÉ/EditeazƒÉ CheltuialƒÉ -->
    <div id="cheltuialaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="cheltuiala-modal-title">AdaugƒÉ CheltuialƒÉ</h3>
                <button class="close-btn" onclick="closeCheltuialaModal()">&times;</button>
            </div>
            
            <form id="cheltuialaForm" onsubmit="saveCheltuiala(event)">
                <input type="hidden" id="cheltuiala-id">

                <div class="form-row">
                    <div class="form-group">
                        <label for="tip-cheltuiala">Tip CheltuialƒÉ *</label>
                        <select id="tip-cheltuiala" required onchange="toggleMaterialCategories()">
                            <option value="materiale">Materiale</option>
                            <option value="manopera">ManoperƒÉ</option>
                            <option value="transport">Transport</option>
                            <option value="altele">Altele</option>
                        </select>
                    </div>
                </div>

                <!-- Categorii materiale (vizibil doar pentru tip "materiale") -->
                <div id="material-categories-section" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="categorie-material">Categorie Material</label>
                            <select id="categorie-material" onchange="updateSubcategories()">
                                <option value="">SelecteazƒÉ categorie...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="subcategorie-material">Subcategorie</label>
                            <select id="subcategorie-material">
                                <option value="">SelecteazƒÉ subcategorie...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cantitate">Cantitate *</label>
                            <input type="number" id="cantitate" step="0.01" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label for="unitate-masura">Unitate MƒÉsurƒÉ</label>
                            <select id="unitate-masura">
                                <option value="">SelecteazƒÉ...</option>
                            </select>
                        </div>
                       
                        <div class="form-group">
                            <label for="pret-unitar">Pre»õ / Unitate (RON) *</label>
                            <input type="number" id="pret-unitar" step="0.01" placeholder="0.00" required>
                        </div>
                    </div>
                    
                    
                </div>
                <!-- Pentru non-materiale, doar suma -->
                <div id="non-material-suma-section" style="display: none;">
                    <div class="form-group">
                        <label for="suma-direct">SumƒÉ TotalƒÉ (RON) *</label>
                        <input type="number" id="suma-direct" step="0.01" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="descriere-cheltuiala">Descriere *</label>
                    <input type="text" id="descriere-cheltuiala" required placeholder="Ex: Lemn stejar pentru blat">
                </div>

                <div class="form-group">
                    <label for="data-cheltuiala">Data CheltuialƒÉ</label>
                    <input type="date" id="data-cheltuiala">
                </div>

                <div class="form-group">
                    <label for="observatii-cheltuiala">Observa»õii</label>
                    <textarea id="observatii-cheltuiala"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCheltuialaModal()">AnuleazƒÉ</button>
                    <button type="submit" class="btn btn-success">üíæ SalveazƒÉ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Upload Imagine -->
    <div id="uploadImageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì§ Upload Imagine Proiect</h3>
                <button class="close-btn" onclick="closeUploadImageModal()">&times;</button>
            </div>

            <form id="uploadImageForm" onsubmit="uploadImage(event)">
                <div class="form-group">
                    <label for="image-file">SelecteazƒÉ imagine *</label>
                    <input type="file" id="image-file" accept="image/jpeg,image/png,image/gif,image/webp" required onchange="previewImage(event)">
                    <small>Format: JPG, PNG, GIF, WEBP | Maxim: 10MB</small>
                </div>

                <!-- Preview imagine -->
                <div id="image-preview" style="display: none; margin-bottom: 20px;">
                    <img id="preview-img" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 2px solid #ddd;">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="tip-imagine">Tip Imagine *</label>
                        <select id="tip-imagine" required>
                            <option value="schita">SchitƒÉ</option>
                            <option value="randare">Randare</option>
                            <option value="final">Final</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ordine-imagine">Ordine Afi»ôare</label>
                        <input type="number" id="ordine-imagine" value="0" min="0">
                        <small>0 = prima imagine</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="descriere-imagine">Descriere (op»õional)</label>
                    <textarea id="descriere-imagine" placeholder="Ex: Vedere frontalƒÉ bucƒÉtƒÉrie"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUploadImageModal()">AnuleazƒÉ</button>
                    <button type="submit" class="btn btn-success">üì§ Upload</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Vizualizare Imagine Mare -->
    <div id="viewImageModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h3 id="view-image-title">Imagine</h3>
                <button class="close-btn" onclick="closeViewImageModal()">&times;</button>
            </div>
            
            <div style="text-align: center; overflow: auto;">
                <img id="view-image-large" style="max-width: 100%; height: auto; border-radius: 8px;">
            </div>
            
            <div style="margin-top: 20px;">
                <p><strong>Tip:</strong> <span id="view-image-tip"></span></p>
                <p><strong>Descriere:</strong> <span id="view-image-descriere"></span></p>
                <p><strong>Data upload:</strong> <span id="view-image-data"></span></p>
            </div>

            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteCurrentImage()">üóëÔ∏è »òterge</button>
                <button class="btn btn-secondary" onclick="closeViewImageModal()">√énchide</button>
            </div>
        </div>
    </div>
    
    <script src="js/api.js"></script>
    <script src="js/material-categories.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/calcul-cant.js"></script>
    <script>
        let proiectId = null;
        let currentProiect = null;
        let currentCheltuialaId = null;

        // Ini»õializare categorii materiale la √ÆncƒÉrcarea paginii
        function initializeMaterialCategories() {
            // PopuleazƒÉ dropdown categorii
            const categorieSelect = document.getElementById('categorie-material');
            const categories = getMaterialCategories();
            categorieSelect.innerHTML = '<option value="">SelecteazƒÉ categorie...</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorieSelect.appendChild(option);
            });

            // PopuleazƒÉ dropdown unitƒÉ»õi de mƒÉsurƒÉ
            const unitateSelect = document.getElementById('unitate-masura');
            unitateSelect.innerHTML = '<option value="">SelecteazƒÉ...</option>';
            UNITATI_MASURA.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.value;
                option.textContent = unit.label;
                unitateSelect.appendChild(option);
            });
        }

        // ActualizeazƒÉ subcategoriile c√¢nd se schimbƒÉ categoria
        function updateSubcategories() {
            const categorieSelect = document.getElementById('categorie-material');
            const subcategorieSelect = document.getElementById('subcategorie-material');
            const unitateSelect = document.getElementById('unitate-masura');
            
            const selectedCategory = categorieSelect.value;
            
            if (selectedCategory) {
                const subcategories = getSubcategories(selectedCategory);
                subcategorieSelect.innerHTML = '<option value="">SelecteazƒÉ subcategorie...</option>';
                subcategories.forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat;
                    option.textContent = subcat;
                    subcategorieSelect.appendChild(option);
                });

                // SeteazƒÉ unitatea implicitƒÉ
                const defaultUnit = getDefaultUnit(selectedCategory);
                unitateSelect.value = defaultUnit;
            } else {
                subcategorieSelect.innerHTML = '<option value="">SelecteazƒÉ subcategorie...</option>';
            }
        }

        // AratƒÉ/ascunde sec»õiunea de categorii materiale
        function toggleMaterialCategories() {
            const tipCheltuiala = document.getElementById('tip-cheltuiala').value;
            const materialSection = document.getElementById('material-categories-section');
            const nonMaterialSection = document.getElementById('non-material-suma-section');
            
            if (tipCheltuiala === 'materiale') {
                materialSection.style.display = 'block';
                nonMaterialSection.style.display = 'none';
                document.getElementById('cantitate').required = true;
                document.getElementById('pret-unitar').required = true;
                document.getElementById('suma-direct').required = false;
            } else {
                materialSection.style.display = 'none';
                nonMaterialSection.style.display = 'block';
                // Reset c√¢mpurile
                document.getElementById('categorie-material').value = '';
                document.getElementById('subcategorie-material').value = '';
                document.getElementById('cantitate').value = '';
                document.getElementById('unitate-masura').value = '';
                document.getElementById('pret-unitar').value = '';
                
                // Set required pentru non-materiale
                document.getElementById('cantitate').required = false;
                document.getElementById('pret-unitar').required = false;
                document.getElementById('suma-direct').required = true;
            }
        }

        function getProiectIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return parseInt(params.get('id'));
        }

        async function loadProiectData() {
            proiectId = getProiectIdFromUrl();
            
            if (!proiectId) {
                showError('ID proiect invalid');
                setTimeout(() => window.location.href = 'proiecte.html', 2000);
                return;
            }

            try {
                currentProiect = await API.getProiect(proiectId);
                displayProiectInfo(currentProiect);
                
                const cheltuieliData = await API.getCheltuieliByProiect(proiectId);
                displayCheltuieli(cheltuieliData.cheltuieli || []);
                displayBreakdown(cheltuieliData.cheltuieliPeTip || []);
                calculateStatistics(currentProiect, cheltuieliData.totalCheltuieli || 0);

                // SeteazƒÉ link-ul √Ænapoi
                document.getElementById('back-link').href = `client-detalii.html?id=${currentProiect.clientId}`;
            } catch (error) {
                showError('Eroare la √ÆncƒÉrcarea datelor proiectului');
                console.error(error);
            }
        }

        function displayProiectInfo(proiect) {
            document.getElementById('proiect-nume').textContent = proiect.numeProiect;
            document.getElementById('proiect-client').textContent = proiect.clientNume;
            
            const statusBadge = getStatusBadge(proiect.status);
            document.getElementById('proiect-status-badge').innerHTML = statusBadge;
            
            document.getElementById('proiect-data-start').textContent = formatDate(proiect.dataStart);
            document.getElementById('proiect-data-finalizare').textContent = formatDate(proiect.dataFinalizare);
            document.getElementById('proiect-pret-estimat').textContent = formatCurrency(proiect.pretEstimat);
            document.getElementById('proiect-pret-final').textContent = formatCurrency(proiect.pretFinal);
            
            const descriereContainer = document.getElementById('proiect-descriere-container');
            if (proiect.descriere) {
                document.getElementById('proiect-descriere').textContent = proiect.descriere;
                descriereContainer.style.display = 'block';
            } else {
                descriereContainer.style.display = 'none';
            }

            document.title = `${proiect.numeProiect} - Atelier T√¢mplƒÉrie`;
        }

        function calculateStatistics(proiect, totalCheltuieli) {
            const incasat = proiect.pretFinal || proiect.pretEstimat || 0;
            const cheltuieli = totalCheltuieli;
            const profit = incasat - cheltuieli;
            const marja = incasat > 0 ? ((profit / incasat) * 100).toFixed(1) : 0;

            document.getElementById('stat-incasat').textContent = formatCurrency(incasat);
            document.getElementById('stat-cheltuieli').textContent = formatCurrency(cheltuieli);
            document.getElementById('stat-profit').textContent = formatCurrency(profit);
            document.getElementById('stat-marja').textContent = marja + '%';

            // SchimbƒÉ culoarea profitului
            const profitCard = document.getElementById('stat-profit').closest('.stat-card');
            if (profit < 0) {
                profitCard.classList.remove('success');
                profitCard.classList.add('danger');
            } else {
                profitCard.classList.remove('danger');
                profitCard.classList.add('success');
            }
        }

        function displayCheltuieli(cheltuieli) {
            const tbody = document.getElementById('cheltuieli-tbody');
            
            if (!cheltuieli || cheltuieli.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">üí∞</div>
                                <h3>Nu existƒÉ cheltuieli pentru acest proiect</h3>
                                <p>AdaugƒÉ prima cheltuialƒÉ pentru a √Æncepe</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            console.log(cheltuieli);

            tbody.innerHTML = cheltuieli.map(ch => {
                let descriereCompleta = ch.descriere;
                
                // AdaugƒÉ categoria »ôi subcategoria dacƒÉ existƒÉ
                if (ch.categorieMaterial) {
                    descriereCompleta += ` <br><span class="badge badge-info" style="font-size: 11px;">${ch.categorieMaterial}</span>`;
                    if (ch.subcategorieMaterial) {
                        descriereCompleta += ` <span class="badge" style="font-size: 11px; background: #6c757d; color: white;">${ch.subcategorieMaterial}</span>`;
                    }
                }
                
                // AdaugƒÉ cantitatea dacƒÉ existƒÉ
                //if (ch.cantitate) {
                //    descriereCompleta += ` <br><small style="color: #666;">Cantitate: ${formatNumber(ch.cantitate)} ${ch.unitateMasura || ''}</small>`;
                //}
                
                return `
                <tr>
                    <td>${formatDate(ch.dataCheltuiala)}</td>
                    <td><span class="badge badge-info">${ch.tipCheltuiala}</span></td>
                    <td>${descriereCompleta}</td>
                    <td style="text-align: left;">${ch.cantitate ? formatNumber(ch.cantitate) + ' ' + (ch.unitateMasura || '') : '-'}</td>
                    <td style="text-align: left;">${ch.pretUnitar ? formatCurrency(ch.pretUnitar) : '-'}</td>
                    <td style="text-align: left;"><strong>${formatCurrency(ch.suma)}</strong></td>
                    <td style="text-align: center;">
                        <button class="btn btn-sm btn-primary" onclick="editCheltuiala(${ch.id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCheltuiala(${ch.id}, '${ch.descriere}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `}).join('');
        }

        function displayBreakdown(cheltuieliPeTip) {
            const container = document.getElementById('breakdown-content');
            
            if (!cheltuieliPeTip || cheltuieliPeTip.length === 0) {
                container.innerHTML = '<p style="color: #999;">Nu existƒÉ cheltuieli</p>';
                return;
            }

            const total = cheltuieliPeTip.reduce((sum, item) => sum + item.total, 0);
            
            container.innerHTML = cheltuieliPeTip.map(item => {
                const procent = total > 0 ? ((item.total / total) * 100).toFixed(1) : 0;
                return `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <strong>${item.tipCheltuiala}</strong>
                            <span>${formatCurrency(item.total)} (${procent}%)</span>
                        </div>
                        <div style="background: #ddd; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="background: var(--secondary-color); width: ${procent}%; height: 100%;"></div>
                        </div>
                        <small style="color: #666;">${item.numar} cheltuieli</small>
                    </div>
                `;
            }).join('');
        }

        function editProiect() {
            document.getElementById('nume-proiect').value = currentProiect.numeProiect;
            document.getElementById('status').value = currentProiect.status;
            document.getElementById('pret-estimat').value = currentProiect.pretEstimat || '';
            document.getElementById('pret-final').value = currentProiect.pretFinal || '';
            document.getElementById('descriere').value = currentProiect.descriere || '';
            document.getElementById('data-start').value = currentProiect.dataStart ? currentProiect.dataStart.split('T')[0] : '';
            document.getElementById('data-finalizare').value = currentProiect.dataFinalizare ? currentProiect.dataFinalizare.split('T')[0] : '';
            document.getElementById('observatii').value = currentProiect.observatii || '';
            document.getElementById('proiectModal').classList.add('active');
        }

        async function saveProiect(event) {
            event.preventDefault();
            
            const proiectData = {
                numeProiect: document.getElementById('nume-proiect').value,
                clientId: currentProiect.clientId,
                status: document.getElementById('status').value,
                descriere: document.getElementById('descriere').value || null,
                pretEstimat: parseFloat(document.getElementById('pret-estimat').value) || null,
                pretFinal: parseFloat(document.getElementById('pret-final').value) || null,
                dataStart: document.getElementById('data-start').value || null,
                dataFinalizare: document.getElementById('data-finalizare').value || null,
                observatii: document.getElementById('observatii').value || null
            };

            try {
                await API.updateProiect(proiectId, proiectData);
                showSuccess('Proiect actualizat cu succes!');
                closeProiectModal();
                loadProiectData();
            } catch (error) {
                showError('Eroare la actualizarea proiectului');
            }
        }

        async function deleteProiect() {
            if (confirmDelete(currentProiect.numeProiect)) {
                try {
                    await API.deleteProiect(proiectId);
                    showSuccess('Proiect »ôters cu succes!');
                    setTimeout(() => window.location.href = `client-detalii.html?id=${currentProiect.clientId}`, 1500);
                } catch (error) {
                    showError('Eroare la »ôtergerea proiectului');
                }
            }
        }

        function openAddCheltuialaModal() {
            currentCheltuialaId = null;
            document.getElementById('cheltuiala-modal-title').textContent = 'AdaugƒÉ CheltuialƒÉ';
            document.getElementById('cheltuialaForm').reset();
            document.getElementById('cheltuiala-id').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-cheltuiala').value = today;
            
            // Ini»õializeazƒÉ categoriile
            initializeMaterialCategories();
            //document.getElementById('tip-cehltuiala').value = 'materiale';
            toggleMaterialCategories();
            
            document.getElementById('cheltuialaModal').classList.add('active');
        }

        async function editCheltuiala(id) {
            try {
                const cheltuiala = await API.getCheltuiala(id);
                currentCheltuialaId = id;
                
                document.getElementById('cheltuiala-modal-title').textContent = 'EditeazƒÉ CheltuialƒÉ';
                document.getElementById('cheltuiala-id').value = cheltuiala.id;
                document.getElementById('tip-cheltuiala').value = cheltuiala.tipCheltuiala;
																		
                document.getElementById('descriere-cheltuiala').value = cheltuiala.descriere;
                document.getElementById('data-cheltuiala').value = cheltuiala.dataCheltuiala ? cheltuiala.dataCheltuiala.split('T')[0] : '';
                document.getElementById('observatii-cheltuiala').value = cheltuiala.observatii || '';
                
                // Ini»õializeazƒÉ categoriile
                initializeMaterialCategories();
                toggleMaterialCategories();
                
                // PopuleazƒÉ c√¢mpurile √Æn func»õie de tip
                if (cheltuiala.tipCheltuiala === 'materiale') {
                    // Materiale: populeazƒÉ categorie, subcategorie, cantitate, pre»õ unitar
                    if (cheltuiala.categorieMaterial) {
                        document.getElementById('categorie-material').value = cheltuiala.categorieMaterial;
                        updateSubcategories();
                        if (cheltuiala.subcategorieMaterial) {
                            document.getElementById('subcategorie-material').value = cheltuiala.subcategorieMaterial;
                        }
                    }
                    if (cheltuiala.cantitate) {
                        document.getElementById('cantitate').value = cheltuiala.cantitate;
                    }
                    if (cheltuiala.unitateMasura) {
                        document.getElementById('unitate-masura').value = cheltuiala.unitateMasura;
                    }
                    if (cheltuiala.pretUnitar) {
                        document.getElementById('pret-unitar').value = cheltuiala.pretUnitar;
                    }
                } else {
                    // Non-materiale: populeazƒÉ doar suma
                    document.getElementById('suma-direct').value = cheltuiala.suma;
                }
										   
                document.getElementById('cheltuialaModal').classList.add('active');
            } catch (error) {
                showError('Eroare la √ÆncƒÉrcarea cheltuielii');
            }
        }
        

        async function saveCheltuiala(event) {
            event.preventDefault();
            
            const tipCheltuiala = document.getElementById('tip-cheltuiala').value;
            
            let suma;
            let cantitate = null;
            let pretUnitar = null;
            
            if (tipCheltuiala === 'materiale') {
                // Pentru materiale: calculeazƒÉ suma = cantitate √ó pre»õ unitar
                cantitate = parseFloat(document.getElementById('cantitate').value) || 0;
                pretUnitar = parseFloat(document.getElementById('pret-unitar').value) || 0;
                suma = cantitate * pretUnitar;
            } else {
                // Pentru non-materiale: ia suma directƒÉ
                suma = parseFloat(document.getElementById('suma-direct').value) || 0;
            }

            const cheltuialaData = {
                proiectId: proiectId,
                tipCheltuiala: tipCheltuiala,
                descriere: document.getElementById('descriere-cheltuiala').value,
                suma: suma,
                dataCheltuiala: document.getElementById('data-cheltuiala').value || null,
                observatii: document.getElementById('observatii-cheltuiala').value || null,
                categorieMaterial: tipCheltuiala === 'materiale' ? (document.getElementById('categorie-material').value || null) : null,
                subcategorieMaterial: tipCheltuiala === 'materiale' ? (document.getElementById('subcategorie-material').value || null) : null,
                cantitate: cantitate,
                unitateMasura: tipCheltuiala === 'materiale' ? (document.getElementById('unitate-masura').value || null) : null,
                pretUnitar: pretUnitar
            };

            try {
                if (currentCheltuialaId) {
                    await API.updateCheltuiala(currentCheltuialaId, cheltuialaData);
                    showSuccess('CheltuialƒÉ actualizatƒÉ cu succes!');
                } else {
                    await API.createCheltuiala(cheltuialaData);
                    showSuccess('CheltuialƒÉ adƒÉugatƒÉ cu succes!');
                }
                
                closeCheltuialaModal();
                loadProiectData();
            } catch (error) {
                showError('Eroare la salvarea cheltuielii');
            }
        }

        async function deleteCheltuiala(id, descriere) {
            if (confirmDelete(descriere)) {
                try {
                    await API.deleteCheltuiala(id);
                    showSuccess('CheltuialƒÉ »ôtearsƒÉ cu succes!');
                    loadProiectData();
                } catch (error) {
                    showError('Eroare la »ôtergerea cheltuielii');
                }
            }
        }

        function closeProiectModal() {
            document.getElementById('proiectModal').classList.remove('active');
        }

        function closeCheltuialaModal() {
            document.getElementById('cheltuialaModal').classList.remove('active');
        }

        window.onclick = function(event) {
            if (event.target === document.getElementById('proiectModal')) {
                closeProiectModal();
            }
            if (event.target === document.getElementById('cheltuialaModal')) {
                closeCheltuialaModal();
            }
        }

        loadProiectData();
        
        let currentExcelData = null;
        let currentCalculResult = null;

        // √éncarcƒÉ calcule salvate pentru proiect
        async function loadCalculeCant() {
            try {
                const calcule = await API.getCalculeByProiect(proiectId);
                displayCalculeSalvate(calcule);
            } catch (error) {
                console.error('Eroare la √ÆncƒÉrcarea calculelor:', error);
            }
        }

        function displayCalculeSalvate(calcule) {
            const container = document.getElementById('calcule-items');
            
            if (!calcule || calcule.length === 0) {
                container.innerHTML = '<p style="color: #999;">Nu existƒÉ calcule salvate pentru acest proiect.</p>';
                return;
            }

            container.innerHTML = calcule.map(c => `
                <div class="stat-card" style="margin-bottom: 10px; cursor: pointer;" onclick="afiseazaCalculSalvat(${c.id})">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0;">${c.numeFisier}</h4>
                            <small>${formatDate(c.dataUpload)}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.5em; font-weight: bold; color: var(--success-color);">
                                ${c.totalCantMetri} ml
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteCalculCant(${c.id}, '${c.numeFisier}')">
                                üóëÔ∏è »òterge
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function afiseazaCalculSalvat(calculId) {
            try {
                const calcul = await API.getCalculCant(calculId);
                afiseazaRezultatCant({
                    totalCantCm: calcul.totalCantCm,
                    totalCantMetri: calcul.totalCantMetri,
                    detalii: calcul.detalii
                }, proiectId);
            } catch (error) {
                showError('Eroare la √ÆncƒÉrcarea calculului');
            }
        }

        async function deleteCalculCant(id, numeFisier) {
            if (confirmDelete(numeFisier)) {
                try {
                    await API.deleteCalculCant(id);
                    showSuccess('Calcul »ôters cu succes!');
                    loadCalculeCant();
                    document.getElementById('calcul-result').style.display = 'none';
                } catch (error) {
                    showError('Eroare la »ôtergerea calculului');
                }
            }
        }

        function openUploadExcelModal() {
            document.getElementById('uploadExcelForm').reset();
            document.getElementById('preview-cant').style.display = 'none';
            currentExcelData = null;
            currentCalculResult = null;
            document.getElementById('uploadExcelModal').classList.add('active');
        }

        function closeUploadExcelModal() {
            document.getElementById('uploadExcelModal').classList.remove('active');
        }

        // Previzualizare c√¢nd se selecteazƒÉ fi»ôier
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('excel-file');
            if (fileInput) {
                fileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        showLoading();
                        const linii = await procesareExcelCant(file);
                        currentExcelData = linii;
                        currentCalculResult = calculeazaCantLocal(linii);
                        
                        // Afi»ôeazƒÉ previzualizare
                        const previewDiv = document.getElementById('preview-content');
                        previewDiv.innerHTML = `
                            <div class="stat-card success">
                                <h4>Total Cant Necesar:</h4>
                                <div style="font-size: 2em; font-weight: bold;">
                                    ${currentCalculResult.totalCantMetri} ml
                                </div>
                                <div style="color: #666;">(${currentCalculResult.totalCantCm} cm)</div>
                            </div>
                            <p><strong>Linii procesate:</strong> ${linii.length}</p>
                        `;
                        document.getElementById('preview-cant').style.display = 'block';
                        hideLoading();
                    } catch (error) {
                        hideLoading();
                        showError(error.message);
                        e.target.value = '';
                    }
                });
            }
        });

        async function uploadExcelCant(event) {
            event.preventDefault();

            if (!currentExcelData || !currentCalculResult) {
                showError('Te rog selecteazƒÉ un fi»ôier Excel valid');
                return;
            }

            const fileInput = document.getElementById('excel-file');
            const fileName = fileInput.files[0].name;
            const observatii = document.getElementById('observatii-cant').value;

            const data = {
                proiectId: proiectId,
                numeFisier: fileName,
                linii: currentExcelData,
                observatii: observatii || null
            };

            try {
                const result = await API.createCalculCant(data);
                showSuccess('Calcul salvat cu succes!');
                closeUploadExcelModal();
                loadCalculeCant();
                afiseazaRezultatCant(result, proiectId);
            } catch (error) {
                showError('Eroare la salvarea calculului');
            }
        }

        window.onclick = function(event) {
            const uploadModal = document.getElementById('uploadExcelModal');
            if (event.target === uploadModal) {
                closeUploadExcelModal();
            }
        };

        // √éncarcƒÉ calcule c√¢nd pagina se √ÆncarcƒÉ
        if (typeof proiectId !== 'undefined' && proiectId) {
            loadCalculeCant();
        }

        let toateImagini = [];
        let currentImageId = null;
        let currentFilter = 'toate';

        // √éncarcƒÉ imagini pentru proiect
        async function loadImagini() {
            try {
                const imagini = await API.getImaginiByProiect(proiectId);
                toateImagini = imagini;
                displayImagini(imagini);
            } catch (error) {
                console.error('Eroare la √ÆncƒÉrcarea imaginilor:', error);
                document.getElementById('galerie-imagini').innerHTML = 
                    '<p style="text-align: center; color: #999;">Nu existƒÉ imagini pentru acest proiect</p>';
            }
        }

        function displayImagini(imagini) {
            const container = document.getElementById('galerie-imagini');
            
            if (!imagini || imagini.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì∏</div>
                            <h3>Nu existƒÉ imagini pentru acest proiect</h3>
                            <p>AdaugƒÉ prima imagine pentru a √Æncepe galeria</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = imagini.map(img => {
                const badgeClass = `badge-${img.tipImagine}`;
                const tipLabel = {
                    'schita': 'SchitƒÉ',
                    'randare': 'Randare',
                    'final': 'Final'
                }[img.tipImagine] || img.tipImagine;

                return `
                    <div class="image-card" onclick="viewImage(${img.id})">
                        <img src="${img.urlImagine}" alt="${img.numeFisier}" loading="lazy">
                        <div class="image-card-content">
                            <div class="image-card-title">
                                <span>${img.numeFisier}</span>
                                <span class="image-type-badge ${badgeClass}">${tipLabel}</span>
                            </div>
                            ${img.descriere ? `<div class="image-card-desc">${img.descriere}</div>` : ''}
                            <div style="font-size: 12px; color: #999;">
                                ${formatDate(img.dataUpload)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterImagini(tip) {
            currentFilter = tip;
            
            // ActualizeazƒÉ butoanele
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-sm');
            });
            document.getElementById(`filter-${tip}`).classList.add('btn-primary');

            // FiltreazƒÉ
            const imaginiFiltrate = tip === 'toate' 
                ? toateImagini 
                : toateImagini.filter(img => img.tipImagine === tip);
            
            displayImagini(imaginiFiltrate);
        }

        function openUploadImageModal() {
            document.getElementById('uploadImageForm').reset();
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('uploadImageModal').classList.add('active');
        }

        function closeUploadImageModal() {
            document.getElementById('uploadImageModal').classList.remove('active');
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            // VerificƒÉ dimensiunea
            if (file.size > 10 * 1024 * 1024) {
                showError('Fi»ôierul este prea mare. Maxim 10MB');
                event.target.value = '';
                return;
            }

            // Afi»ôeazƒÉ preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('image-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function uploadImage(event) {
            event.preventDefault();

            const fileInput = document.getElementById('image-file');
            const file = fileInput.files[0];

            if (!file) {
                showError('Te rog selecteazƒÉ o imagine');
                return;
            }

            // CreeazƒÉ FormData
            const formData = new FormData();
            formData.append('file', file);
            formData.append('ProiectId', proiectId);
            formData.append('TipImagine', document.getElementById('tip-imagine').value);
            formData.append('Descriere', document.getElementById('descriere-imagine').value || '');
            formData.append('Ordine', document.getElementById('ordine-imagine').value || 0);

            try {
                await API.uploadImagine(formData);
                showSuccess('Imagine √ÆncƒÉrcatƒÉ cu succes!');
                closeUploadImageModal();
                loadImagini();
            } catch (error) {
                console.error('Upload error:', error);
                showError('Eroare la incarcarea imaginii');
            }
        }

        async function viewImage(imageId) {
            try {
                const imagine = await API.getImagine(imageId);
                currentImageId = imagine.id;
                
                const tipLabel = {
                    'schita': 'SchitƒÉ',
                    'randare': 'Randare',
                    'final': 'Final'
                }[imagine.tipImagine] || imagine.tipImagine;

                document.getElementById('view-image-title').textContent = imagine.numeFisier;
                document.getElementById('view-image-large').src = imagine.urlImagine;
                document.getElementById('view-image-tip').textContent = tipLabel;
                document.getElementById('view-image-descriere').textContent = imagine.descriere || '-';
                document.getElementById('view-image-data').textContent = formatDate(imagine.dataUpload);
                
                document.getElementById('viewImageModal').classList.add('active');
            } catch (error) {
                showError('Eroare la √ÆncƒÉrcarea imaginii');
            }
        }

        function closeViewImageModal() {
            document.getElementById('viewImageModal').classList.remove('active');
            currentImageId = null;
        }

        async function deleteCurrentImage() {
            if (!currentImageId) return;

            if (confirm('Sigur vrei sƒÉ »ôtergi aceastƒÉ imagine?\n\nAceastƒÉ ac»õiune nu poate fi anulatƒÉ.')) {
                try {
                    await API.deleteImagine(currentImageId);
                    showSuccess('Imagine »ôtearsƒÉ cu succes!');
                    closeViewImageModal();
                    loadImagini();
                } catch (error) {
                    showError('Eroare la »ôtergerea imaginii');
                }
            }
        }

        // Event listeners pentru modal-uri
        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('uploadImageModal')) {
                closeUploadImageModal();
            }
            if (event.target === document.getElementById('viewImageModal')) {
                closeViewImageModal();
            }
        });

        // √éncarcƒÉ imagini c√¢nd pagina se √ÆncarcƒÉ
        if (typeof proiectId !== 'undefined' && proiectId) {
            loadImagini();
        }
    </script>
</body>
</html>